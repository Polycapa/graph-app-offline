<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<dom-module id="dragdrop-window">
    <template>
        <style>
             :host {
                display: block;
                --top-pos: 0;
                --left-pos: 0;
                --z-index: 2;
            }

            #drag {
                position: fixed;
                top: var(--top-pos);
                left: var(--left-pos);
                z-index: var(--z-index);
            }
        </style>

        <div on-track="handleTrack" id="drag" on-mousedown="saveMouseRelativePos" on-mouseup="resetMouseRelativePos">
            <slot></slot>
        </div>

    </template>

    <script>
        /**
         * `dragdrop-window` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.GestureEventListeners(Polymer.Element)}
         */
        class DragDropWindow extends Polymer.GestureEventListeners(Polymer.Element) {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'dragdrop-window';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    top: {
                        type: Number,
                        value: 0,
                        observer: 'updateTopPos'
                    },
                    left: {
                        type: Number,
                        value: 0,
                        observer: 'updateLeftPos'
                    },
                    mouseRelativePos: {
                        type: Object,
                        value: () => {
                            return {
                                x: 0,
                                y: 0
                            };
                        }
                    }
                };
            }

            saveMouseRelativePos(e) {
                this.mouseRelativePos.x = e.pageX - this.$.drag.offsetLeft;
                this.mouseRelativePos.y = e.pageY - this.$.drag.offsetTop;
                this.updateZIndex(100);
            }

            resetMouseRelativePos(e) {
                this.mouseRelativePos.x = 0;
                this.mouseRelativePos.y = 0;
                this.updateZIndex(2);
            }

            handleTrack(e) {
                switch (e.detail.state) {
                    case 'start':
                        this.updateZIndex(2);
                        this.emit('drag-start', {
                            x: this.getLeftPos(),
                            y: this.getTopPos(),
                        })
                        break;
                    case 'track':
                        this.updateZIndex(100);
                        this.updatePos(e.detail.y - this.mouseRelativePos.y,
                            e.detail.x - this.mouseRelativePos.x);
                        this.emit('drag', {
                            x: this.getLeftPos(),
                            y: this.getTopPos(),
                        })
                        break;
                    case 'end':
                        this.updateZIndex(2);
                        this.emit('drag-end', {
                            x: this.getLeftPos(),
                            y: this.getTopPos(),
                        })
                        break;
                }
                // console.log(this.message);
                e.preventDefault();

            }

            getTopPos() {
                let style;
                if (window.ShadyCSS) {
                    style = ShadyCSS.getComputedStyleValue(this, '--top-pos');
                } else {
                    style = getComputedStyle(el).getPropertyValue('--top-pos');
                }

                style = Number(style.substring(0, style.indexOf('px')));
                return style;
            }

            getLeftPos() {
                let style;
                if (window.ShadyCSS) {
                    style = ShadyCSS.getComputedStyleValue(this, '--left-pos');
                } else {
                    style = getComputedStyle(el).getPropertyValue('--left-pos');
                }

                style = Number(style.substring(0, style.indexOf('px')));
                return style;
            }

            updatePos(top, left) {
                this.updateStyles({
                    '--top-pos': top + 'px',
                    '--left-pos': left + 'px'
                });
            }

            updateTopPos(top) {
                this.updateStyles({
                    '--top-pos': top + 'px'
                });
            }

            updateLeftPos(left) {
                this.updateStyles({
                    '--left-pos': left + 'px'
                });
            }

            updateZIndex(zIndex) {
                this.updateStyles({
                    '--z-index': zIndex
                });
            }

            emit(eventName, data) {
                let event = new CustomEvent(eventName, {
                    detail: data
                });

                this.dispatchEvent(event);
            }

        }

        window.customElements.define(DragDropWindow.is, DragDropWindow);
    </script>
</dom-module>